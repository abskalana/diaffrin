{% extends 'parent.html' %}

{% block content %}
<br>
<div class="d-flex justify-content-between align-items-center mb-3">
    <!-- Titre -->
    <h2 class="m-0">
        Status des paiements - {{ mois_selected }} {{ year_selected }}
        <span class="status" data-status="{{ request.GET.status }}">
            {{ request.GET.status }}
        </span>
    </h2>

    <!-- Mini récap -->
    <div class="d-flex gap-2">
        <div class="px-2 py-1 bg-primary text-white rounded">
            <small><strong>Items:</strong> {{ nombre_items|default:"--" }}</small>
        </div>
        <div class="px-2 py-1 bg-success text-white rounded">
            <small><strong>Portes:</strong> {{ nombre_portes|default:"--" }}</small>
        </div>
        <div class="px-2 py-1 bg-warning text-dark rounded">
            <small><strong>Montant:</strong> {% if montant_total %}{{ montant_total }} FCFA{% else %}--{% endif %}</small>
        </div>
    </div>
</div>

<br>
<br>

<form method="get" class="container mb-3">
    <div class="row g-2 justify-content-center align-items-center">

        <!-- Année -->
        <div class="col-md-2 col-6">
            <input type="number" name="annee" class="form-control" value="{{ year_selected|default:current_year }}">
        </div>

        <!-- Mois -->
        <div class="col-md-2 col-6">
            <select name="mois" class="form-select">
                <option value="">Tous</option>
                {% for m in MONTH_CHOICES %}
                <option value="{{ m.0 }}" {% if mois_selected == m.0 %}selected{% endif %}>{{ m.1 }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- City -->
        <div class="col-md-2 col-6">
            <select class="form-select" name="city" id="city">
                <option value="">-- Tous --</option>
                {% for l in city %}
                <option value="{{ l }}" {% if request.GET.city == l %}selected{% endif %}>{{ l }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Locality -->
        <div class="col-md-2 col-6">
            <select class="form-select" name="locality" id="locality">
                <option value="">-- Tous --</option>
                {% for l in localities %}
                <option value="{{ l }}" {% if request.GET.locality == l %}selected{% endif %}>{{ l }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Property -->
        <div class="col-md-2 col-6">
            <select class="form-select" name="property" id="property">
                <option value="">-- Tous --</option>
                {% for p in properties %}
                <option value="{{ p }}" {% if request.GET.property == p %}selected{% endif %}>{{ p }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Status -->
        <div class="col-md-2 col-6">
            <select class="form-select" name="status" id="status">
                <option value="">-- Tous --</option>
                {% for p in statuses %}
                <option value="{{ p }}" {% if request.GET.status == p %}selected{% endif %}>{{ p }}</option>
                {% endfor %}
            </select>
        </div>


        <!-- Boutons -->
        <div class="col-auto d-flex">
            <button type="submit" class="btn btn-primary me-2">Filtrer</button>
            <a href="{% url 'home' %}" class="btn btn-secondary">Réinitialiser</a>
        </div>
    </div>
</form>


<br><br>

    <div class="row text-center" style="height: 60px; line-height: 30px;">
        <div class="col-md-4 bg-primary text-white rounded-start d-flex align-items-center justify-content-center">
            <div>
                <strong>Nombre d'items :</strong><br>
                {{ nombre_items|default:"--" }}
            </div>
        </div>
        <div class="col-md-4 bg-success text-white d-flex align-items-center justify-content-center">
            <div>
                <strong>Nombre de portes :</strong><br>
                {{ nombre_portes|default:"--" }}
            </div>
        </div>
        <div class="col-md-4 bg-warning text-dark rounded-end d-flex align-items-center justify-content-center">
            <div>
                <strong>Montant total :</strong><br>
                {% if montant_total %}{{ montant_total }} FCFA{% else %}--{% endif %}
            </div>
        </div>
    </div>


<br><br>

<table class="table table-striped">
    <thead class="thead-dark">
    <tr>
        <th>#</th>
        <th scope="col">Ville</th>
        <th scope="col">Place</th>
        <th scope="col">Nom</th>
        <th scope="col">Prénom</th>
        <th scope="col">Phone</th>
        <th scope="col">Activité</th>
        <th scope="col">Propriété</th>
        <th scope="col">Type</th>
        <th scope="col">#Porte</th>

        <th scope="col">Paiement montant</th>
        <th scope="col">Paiement Status</th>
        <th scope="col">Paiement Mois</th>
        <th scope="col">Paiement Date</th>
        <th scope="col">Detail</th>

    </tr>
    </thead>
    <tbody>
    {% for entity in entities %}
    <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ entity.city }}</td>
        <td>{{ entity.locality }}</td>
        <td>{{ entity.contact_nom }}</td>
        <td>{{ entity.contact_prenom }}</td>
        <td>{{ entity.contact_phone }}</td>
        <td>{{ entity.activity }}</td>
        <td>{{ entity.property }}</td>
        <td>{{ entity.type_entity }}</td>
        <td>{{ entity.porte }}</td>
        <td>
            {% if entity.paiement %}
            {{ entity.paiement.value }}
            {% else %}
            <span class="text-muted">--</span>
            {% endif %}
        </td>

       <td>
            {% if entity.paiement %}
                <span class="status" data-status="{{ entity.paiement.status }}">
                    {{ entity.paiement.status }}
                </span>
            {% else %}
                <span class="text-muted">--</span>
            {% endif %}
            </td>

        <td>
            {% if entity.paiement %}
            {{ entity.paiement.mois }} {{ entity.paiement.annee }}
            {% else %}
            <span class="text-muted">--</span>
            {% endif %}
        </td>
        <td>
            {% if entity.paiement %}
            {{ entity.paiement.date_created|date:"d/m/Y H\hi" }}
            {% else %}
            <span class="text-muted">--</span>
            {% endif %}
        </td>

        <td>
            <a href="{{ entity.get_absolute_url }}">Détails</a>
        </td>
    </tr>
    {% endfor %}
    </tbody>
</table>
</div>
{% endblock %}